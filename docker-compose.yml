services:
  # Spring Boot Application
  app:
    image: ghcr.io/saufi-opi/library-api-springboot:latest
    container_name: library-api-app
    restart: unless-stopped
    environment:
      # Database connection (matches application.yaml)
      POSTGRES_SERVER: ${POSTGRES_SERVER}
      POSTGRES_PORT: ${POSTGRES_PORT}
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

      # Application config
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      PORT: ${PORT}
      DDL_AUTO: ${DDL_AUTO}

      # JWT Configuration
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_EXPIRATION: ${JWT_EXPIRATION}
      JWT_ISSUER: ${JWT_ISSUER}
      JWT_AUDIENCE: ${JWT_AUDIENCE}

      # CORS
      CORS_ALLOWED_ORIGINS: ${CORS_ALLOWED_ORIGINS}

      # Seed users
      ADMIN_EMAIL: ${ADMIN_EMAIL}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      ADMIN_FULLNAME: ${ADMIN_FULLNAME}
      LIBRARIAN_EMAIL: ${LIBRARIAN_EMAIL}
      LIBRARIAN_PASSWORD: ${LIBRARIAN_PASSWORD}
      LIBRARIAN_FULLNAME: ${LIBRARIAN_FULLNAME}
      MEMBER_EMAIL: ${MEMBER_EMAIL}
      MEMBER_PASSWORD: ${MEMBER_PASSWORD}
      MEMBER_FULLNAME: ${MEMBER_FULLNAME}
    ports:
      - "${PORT}:${PORT}"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:${PORT}/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
